version: '3'

env:
  CR_PAT: "{{.CR_PAT}}"

vars:
  APPNAME: myapiserver
  VERSION:
    sh: git describe --tags --always --dirty="-dev"
  VERSION_SHORT:
    sh: git describe --tags --always --dirty="-dev" --abbrev=0
  IMGNAME: ghcr.io/ericslandry/{{.APPNAME}}
  IMGLONG: "{{.IMGNAME}}:{{.VERSION}}"
  IMGSHORT: "{{.IMGNAME}}:{{.VERSION_SHORT}}"
  IMGLATEST: "{{.IMGNAME}}:latest"

tasks:
  clean:
    cmds:
      - rm -rf bin
      - docker image prune -af

  build:
    cmds:
      - task: clean
      - go generate ./api/api.go
      - go build -ldflags "-w -X main.version={{.VERSION}}" -o bin/{{.APPNAME}} ./cmd/{{.APPNAME}}

  docker-build:
    cmds:
      - task: build
      - docker buildx build . --build-arg APPNAME={{.APPNAME}} -t {{.IMGLONG}} -t {{.IMGSHORT}} -t {{.IMGLATEST}}

  docker-push:
    cmds:
      - task: docker-build
      - |
        if [ -z "${CR_PAT}" ]; then
          echo "Error: CR_PAT environment variable is not set. Please set it to proceed.";
          exit 1;
        fi
      - echo $CR_PAT | docker login ghcr.io -u erislandry --password-stdin
      - docker push --all-tags {{.IMGNAME}}

  test:
    cmds:
      - go test -v ./...

  run:
    cmds:
      - go run ./cmd/{{.APPNAME}}

  kill:
    cmds:
      - pkill {{.APPNAME}}

  default:
    desc: "Build and Test"
    cmds:
      - task: build
      - task: test
